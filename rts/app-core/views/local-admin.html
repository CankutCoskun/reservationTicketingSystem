<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/bootstrap-resources/stylesheets/bootstrap.min.css">
    <link rel="stylesheet" href="/bootstrap-resources/stylesheets/w3.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>

    <title>Local Admin</title>

    <script>

    </script>
</head>

<body>
    <header>
        <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark shadow-sm">
            <img src="<%=logoPath%>" class="d-inline-block align-center" alt="" width="120" height="60">
            <h5 class="modal-title" id="title" style="color: white; border-color: white; margin-left: 20px;">
                <%= compname %>
            </h5>
            <div class="collapse navbar-collapse" id="navbarColor02">
                <ul class="nav navbar-nav navbar-right ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/logout" style="color: white;"><i class="fa fa-fw fa-sign-out"></i>
                            Logout</a>
                    </li>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <main role="main" class="">

        <div class=" container" style="margin-top: 100px; margin-left: 30px;">
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addModal"
                style="margin: 15px; background-color: #0d5abe;">
                Add Event
            </button>
            <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#addVenue"
                style="margin: 15px;">
                Add Venue
            </button>

            <br>
            <br>

            <!-- Add Event Modal -->
            <div class="modal fade" id="addModal" data-backdrop="static" tabindex="-1" role="dialog"
                aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="staticBackdropLabel">Add Event</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form action="/api/events/add" enctype="multipart/form-data" method="POST">
                                <div class="form-group">
                                    <label for="EventInformation">Event Title</label>
                                    <input type="text" class="form-control" name="eventtitle" id="eventtitle"
                                        placeholder="Event Title" required>
                                </div>
                                <div class="form-group">
                                    <label for="EventInformation">Event Venue ID</label>
                                    <input type="text" class="form-control" name="eventvenue" id="eventvenue"
                                        placeholder="Event Venue" required>
                                </div>
                                <div class="form-group">
                                    <label for="EventInformation">Event Date</label>
                                    <input type="date" class="form-control" name="eventdate" id="eventdate"
                                        placeholder="Event Date" required>
                                </div>
                                <div class="form-group">
                                    <label for="EventInformation">Event Time</label>
                                    <input type="time" class="form-control" name="eventtime" id="eventtime"
                                        placeholder="Event Time" required>
                                </div>
                                <div class="form-group">
                                    <label for="eventtype">Event Type</label>
                                    <select type="text" class="form-control" name="eventtype" id="eventtype" required>
                                        <option value="CONCERT">CONCERT</option>
                                        <option value="THEATRE">THEATRE</option>
                                        <option value="DANCE">DANCE</option>
                                        <option value="STANDUP">STANDUP</option>
                                        <option value="OPERA">OPERA</option>
                                        <option value="MUSICAL">MUSICAL</option>
                                        <option value="BALLET">BALLET</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="city">City</label>
                                    <select type="text" class="form-control" name="city" id="city" required>
                                        <option value="ANKARA">ANKARA</option>
                                        <option value="ANTALYA">ANTALYA</option>
                                        <option value="ISTANBUL">ISTANBUL</option>
                                        <option value="IZMIR">IZMIR</option>
                                        <option value="BURSA">BURSA</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="EventInformation">Event Detail</label>
                                    <input type="text" class="form-control" name="eventdetail" id="eventdetail"
                                        placeholder="Event Detail" required>
                                </div>
                                <div class="form-group">
                                    <h4 class="modal-title">Upload Image</h5>
                                        <input type="file" name="myFile" class="form-control-file"
                                            id="exampleFormControlFile1">
                                </div>
                                <input type="number" name="compid" value="<%= compid %>" style="display:none;"> 
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                    <input type='submit' name='addevent' class="btn btn-primary  active" role="button"
                                        aria-pressed="true" value="Add New Event">
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!--Add Venue Modal -->
            <div class="modal fade" id="addVenue" data-backdrop="static" tabindex="-1" role="dialog"
                aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="staticBackdropLabel">Add Venue</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form action="/api/venues/add" enctype="multipart/form-data" method="POST">
                                <div class="form-group">
                                    <label for="vname">Venue Name</label>
                                    <input type="text" class="form-control" name="vname" id="vname"
                                        placeholder="Venue Name" required>
                                </div>

                                <div class="form-group">
                                    <label for="vname">Venue Capacity</label>
                                    <input type="number" class="form-control" name="vcap" id="vcap"
                                        placeholder="Venue Capacity" required>
                                </div>

                                <div class="form-group">
                                    <h4 class="modal-title">Upload Image</h5>
                                        <input type="file" name="myFile" class="form-control-file"
                                            id="exampleFormControlFile1">
                                </div>
                                <input type="number" name="compid" value="<%= compid %>" style="display:none;"> 

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                    <input type='submit' name='addVenue' class="btn btn-primary  active" role="button"
                                        aria-pressed="true" value="Add New Venue">
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <table id=eventtable class="table table-striped" style="width: 130%;">
                <thead>
                    <tr>
                        <!--  <th scope="col">Company Image</th> -->
                        <th scope="col">Poster</th>
                        <th scope="col">ID</th>
                        <th scope="col">Title</th>
                        <th scope="col">Venue</th>
                        <th scope="col">Date</th>
                        <th scope="col">Time</th>
                        <th scope="col">City</th>
                        <th scope="col">Type</th>
                        <th scope="col">Detail</th>
                        <th scope="col">Display categories</th>
                        <th scope="col">Add new category</th>
                        <th scope="col">Delete event</th>

                    </tr>
                </thead>
                <tbody id="events">
                    <% for(var i=0; i < events.length; i++) { %>
                    <tr>
                        <td class="w-25">
                            <a href="<%= events[i].imagePath %>">
                                <img src="<%= events[i].imagePath%>" class="img-fluid img-thumbnail">
                            </a>
                        </td>
                        <td><%= events[i].eId %></td>
                        <td><%= events[i].title %></td>
                        <td><%= events[i].venueId %></td>
                        <td><%= new Date(events[i].date).toDateString()%></td>
                        <td><%= events[i].time %></td>
                        <td><%= events[i].city %></td>
                        <td><%= events[i].eType %></td>
                        <td><%= events[i].detail %></td>
                        <td>
                            <div class="container">
                                <a href="#table_<%=events[i].eId%>" class="btn btn-primary" data-toggle="collapse"
                                    style="background-color: #0d5abe; height: 35px;">
                                    Categories
                                </a>

                                <div id="table_<%=events[i].eId%>" class="collapse">
                                    <table class="table" id="categoryTable">
                                        <thead>
                                            <tr>
                                                <th scope="col">#</th>
                                                <th scope="col">name</th>
                                                <th scope="col">capacity</th>
                                                <th scope="col">remaining</th>
                                                <th scope="col">price</th>
                                            </tr>
                                        </thead>
                                        <tbody id="categories_<%=events[i].eId%>">
                                            <!--
                                                DYNAMICALLY FILLED
                                            -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="text-md-left">
                                <!-- Button trigger modal -->
                                <input id="cbtn" value="Add Category" type="submit" class="btn btn-dark generate"
                                    data-toggle="modal" data-target="#modal_<%=events[i].eId %>">
                            </div>
                            <!-- Modal -->
                            <div class="modal fade" id="modal_<%=events[i].eId %>" tabindex="-1" role="dialog">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <form action="/api/events/category/add/<%=events[i].eId%>" method="POST">
                                            <div class="modal-body">
                                                <div class="form-group">
                                                    <label>Category Name</label>
                                                    <input type="text" name="cname" class="form-control"
                                                        placeholder="name" required="">
                                                </div>
                                                <div class="form-group">
                                                    <label> Capacity</label>
                                                    <input type="number" name="ccap" class="form-control"
                                                        placeholder="capacity" required="">
                                                </div>
                                                <div class="form-group">
                                                    <label> Price ₺</label>
                                                    <input type="number" name="cprice" class="form-control"
                                                        placeholder="price" required="">
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary"
                                                    data-dismiss="modal">Close</button>
                                                <button type="submit" class="btn btn-primary">Save changes</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <input type='submit' name='delete' class='btn btn-sm btn-danger' role='button'
                                value='Delete' onclick="deleteFunc(<%= events[i].eId %>)">
                        </td>
                    </tr>
                    <% } %>

                </tbody>
            </table>
            <br>
            <br>
            <table id=venuetable class="table table-striped">

                <thead id="venues">
                    <tr>
                        <th scope="col">Seating Plan</th>
                        <th scope="col">Venue ID</th>
                        <th scope="col">Name</th>
                        <th scope="col">Capacity</th>
                        <th scope="col">Delete venue</th>
                    </tr>
                </thead>

                <tbody id="venues">

                    <% for( var i=0; i < venues.length; i++) { %>
                    <tr>
                        <td class="w-25">
                            <a href="<%= venues[i].imagePath %>"><img src="<%= venues[i].imagePath%>"
                                    class="img-fluid img-thumbnail"></a>
                        </td>
                        <td><%= venues[i].vid %></td>
                        <td><%= venues[i].name %></td>
                        <td><%= venues[i].vcapacity %></td>
                        <td>
                            <input type='submit' name='delete' class='btn btn-sm btn-danger' role='button'
                                value='Delete' onclick="deleteVenue(<%= venues[i].vid %>)" style='height: 35px;'>
                        </td>
                    </tr>
                    <% } %>

                </tbody>
            </table>
        </div>

    </main>

    <script>



        function deleteCategory(cid) {
            //alert(cid);
            var xmlhttp = new XMLHttpRequest();
            var a = "api/events/category/delete/" + String(cid);
            xmlhttp.open("DELETE", a, true);
            xmlhttp.send();
            window.location.reload();
        }

        function deleteFunc(eId) {
            var xmlhttp = new XMLHttpRequest();
            var a = "/api/events/delete/" + String(eId);
            xmlhttp.open("DELETE", a, true);
            xmlhttp.send();
            window.location.reload();
        }

        function addCategory(vid) {
            //NOT USED
            var xmlhttp = new XMLHttpRequest();
            var targetApi = "/api/venues/category/add/" + String(vid);
            xmlhttp.open("POST", targetApi, true);
            xmlhttp.send();
            window.location.reload();
        }

        function writeCategories(eid) {
            var xmlhttp = new XMLHttpRequest();

            xmlhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var rowCount = $('#categoryTable >tbody >tr').length;
                    const data = JSON.parse(this.responseText);
                    if (rowCount != data.length) {
                        var table_body = document.getElementById('categories_' + String(eid));
                        data.forEach(function (category) {
                            console.log(category);
                            var row = document.createElement('tr');
                            var id = document.createElement('td');
                            id.innerText = category.categoryid;
                            var name = document.createElement('td');
                            name.innerText = category.categoryname;
                            var capacity = document.createElement('td');
                            capacity.innerText = category.capacity;
                            var price = document.createElement('td');
                            price.innerText = category.price;
                            var rem = document.createElement('td');
                            rem.innerText = category.remaining;
                            var dlt = document.createElement('td');
                            var dltbtn = document.createElement("input");
                            dltbtn.setAttribute("type", "submit");
                            dltbtn.setAttribute("class", "btn btn-sm btn-danger");
                            dltbtn.setAttribute("value", "del");
                            var cid = category.categoryid;
                            dltbtn.setAttribute("onclick", "deleteCategory(" + cid.toString() + ")");
                            dlt.appendChild(dltbtn);
                            //"<input type='submit' class='btn btn-sm btn-danger' role='button' value = 'X' onclick ='deleteCategory()' >" 
                            row.appendChild(id);
                            row.appendChild(name);
                            row.appendChild(capacity);
                            row.appendChild(rem);
                            row.appendChild(price);
                            row.appendChild(dlt);
                            table_body.appendChild(row);
                        });
                    }
                }
            };

            var targetApi = "/api/events/category/all/" + String(eid);
            xmlhttp.open("GET", targetApi, true);
            xmlhttp.send();

        }
        
        <% for (var i = 0; i < events.length; i++) { %>
            //alert(<%=events[i].eId %>);
            writeCategories(<%=events[i].eId %>);
        <%}%>


    </script>

</body>

</html>